<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Farming Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #283048, #859398);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        header h1 {
            font-size: 1.5rem;
            color: #4ade80;
        }

        nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        nav button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        nav button:hover, nav button.active {
            background: #4ade80;
            color: #1a1a2e;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .stats-bar {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #4ade80;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .card h2 {
            margin-bottom: 15px;
            color: #4ade80;
            font-size: 1.3rem;
        }

        .btn {
            background: #4ade80;
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 222, 128, 0.4);
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            /* background: rgba(255, 255, 255, 0.2); */
            /* color: #fff; */
            background: #ddd;
            color: #333;
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: #ef4444;
            color: #fff;
        }

        .btn-prestige {
            background: linear-gradient(135deg, #a855f7, #ec4899);
            color: #fff;
        }

        .cooldown-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: #1a1a2e;
            transition: width 0.1s linear;
        }

        .farm-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .farm-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            min-width: 150px;
        }

        select option {
            background: #283048;
            color: #fff;
        }

        .notification-container {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }

        .notification {
            padding: 12px 20px;
            border-radius: 10px;
            animation: slideIn 0.3s ease, fadeOut 0.5s ease 1.5s forwards;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification.normal { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .notification.rare { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .notification.epic { background: linear-gradient(135deg, #a855f7, #9333ea); }
        .notification.mythical { background: linear-gradient(135deg, #ec4899, #db2777); }
        .notification.legendary { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .notification.relic { background: linear-gradient(135deg, #F5D0C5, #F2B39B); }
        .notification.ancient { background: linear-gradient(135deg, #D9F99D, #A3E635); }
        .notification.exalted { background: linear-gradient(135deg, #FBCFE8, #F9A8D4); }
        .notification.achievement { background: linear-gradient(135deg, #EFCA08, #F08700); color: #ffffff; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(100%); }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .item-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: transform 0.2s;
        }

        .item-card:hover {
            transform: translateY(-3px);
        }

        .item-card.owned {
            border: 2px solid #4ade80;
        }

        .item-card.equipped {
            border: 2px solid #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-name {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .item-price {
            color: #4ade80;
            font-weight: bold;
        }

        .item-stats {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .progress-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            height: 8px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #4ade80;
            transition: width 0.3s;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .inventory-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inventory-item.normal { border-left: 3px solid #22c55e; }
        .inventory-item.rare { border-left: 3px solid #3b82f6; }
        .inventory-item.epic { border-left: 3px solid #a855f7; }
        .inventory-item.mythical { border-left: 3px solid #ec4899; }
        .inventory-item.legendary { border-left: 3px solid #f59e0b; }
        .inventory-item.relic { border-left: 3px solid #F5D0C5; }
        .inventory-item.ancient { border-left: 3px solid #D9F99D; }
        .inventory-item.exalted { border-left: 3px solid #FBCFE8; }

        .inventory-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .achievement-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
            opacity: 0.5;
            transition: all 0.3s;
        }

        .achievement-card.unlocked {
            opacity: 1;
            border: 1px solid #fbbf24;
        }

        .achievement-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .achievement-info h3 {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .achievement-info p {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .stats-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stats-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4ade80;
            margin-bottom: 5px;
        }

        .stats-card .label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .prestige-info {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2));
            border: 1px solid rgba(168, 85, 247, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .prestige-info h3 {
            color: #ec4899;
            margin-bottom: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #283048, #3d4f6f);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            color: #4ade80;
            margin-bottom: 20px;
        }

        .modal-content textarea {
            width: 100%;
            height: 150px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            padding: 10px;
            font-family: monospace;
            resize: vertical;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .fertilizer-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .fertilizer-badge {
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .keyboard-hint {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 5px;
        }

        .upgrade-level {
            background: rgba(74, 222, 128, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        @media (max-width: 600px) {
            header {
                flex-direction: column;
                text-align: center;
            }

            nav {
                justify-content: center;
            }

            .stats-bar {
                justify-content: center;
                text-align: center;
            }

            .btn {
                padding: 15px 20px;
                min-height: 44px;
            }

            select {
                min-height: 44px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>üåæ Virtual Farming Simulator</h1>
        <nav>
            <button class="nav-btn active" data-page="main">Main</button>
            <button class="nav-btn" data-page="shop">Shop</button>
            <button class="nav-btn" data-page="upgrades">Upgrades</button>
            <button class="nav-btn" data-page="inventory">Inventory</button>
            <button class="nav-btn" data-page="stats">Stats</button>
            <button class="nav-btn" data-page="achievements">Achievements</button>
        </nav>
    </header>

    <div class="stats-bar">
        <div class="stat-item">
            <span class="stat-label">Balance</span>
            <span class="stat-value" id="balance-display">$0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">XP</span>
            <span class="stat-value" id="xp-display">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Plants</span>
            <span class="stat-value" id="plants-display">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Current Hoe</span>
            <span class="stat-value" id="hoe-display">Wooden Hoe</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Prestige</span>
            <span class="stat-value" id="prestige-display">‚≠ê 0</span>
        </div>
    </div>

    <div class="container">
        <div class="notification-container" id="notifications"></div>

        <!-- Main Page -->
        <div class="page active" id="page-main">
            <div class="card">
                <h2>üöú Farm</h2>
                <div class="farm-section">
                    <div class="farm-controls">
                        <select id="hoe-select"></select>
                        <select id="fertilizer-select">
                            <option value="none">No Fertilizer</option>
                        </select>
                    </div>
                    <button class="btn" id="farm-btn" style="font-size: 1.2rem; padding: 20px 50px;">
                        üå± Farm
                        <div class="cooldown-bar" id="cooldown-bar"></div>
                    </button>
                    <p class="keyboard-hint">Press [Space] to farm</p>
                    <button class="btn btn-secondary" id="sell-btn">üí∞ Sell All Plants</button>
                    <p class="keyboard-hint">Press [S] to sell</p>
                </div>
            </div>

            <div class="card prestige-info" id="prestige-card" style="display: none;">
                <h3>‚ú® Prestige Available!</h3>
                <p id="prestige-description"></p>
                <button class="btn btn-prestige" id="prestige-btn" style="margin-top: 15px;">üåü Prestige Now</button>
            </div>

            <div class="card">
                <h2>üíæ Save Management</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" id="export-btn">üì§ Export Save</button>
                    <button class="btn btn-secondary" id="import-btn">üì• Import Save</button>
                </div>
            </div>
        </div>

        <!-- Shop Page -->
        <div class="page" id="page-shop">
            <div class="card">
                <h2>üõ†Ô∏è Hoe Shop</h2>
                <div class="grid" id="hoe-grid"></div>
            </div>

            <div class="card">
                <h2>üß™ Fertilizer Shop</h2>
                <div class="grid" id="fertilizer-grid"></div>
            </div>
        </div>

        <!-- Upgrades Page -->
        <div class="page" id="page-upgrades">
            <div class="card">
                <h2>‚¨ÜÔ∏è Upgrades</h2>
                <p style="margin-bottom: 15px; color: rgba(255,255,255,0.7);">Costs increase exponentially: Base √ó 1.15^Level</p>
                <div class="grid" id="upgrade-grid"></div>
            </div>
        </div>

        <!-- Inventory Page -->
        <div class="page" id="page-inventory">
            <div class="card">
                <h2>üéí Inventory</h2>
                <div class="inventory-controls">
                    <select id="sort-select">
                        <option value="name">Sort by Name</option>
                        <option value="quantity">Sort by Quantity</option>
                        <option value="value">Sort by Value</option>
                        <option value="rarity">Sort by Rarity</option>
                    </select>
                    <select id="filter-select">
                        <option value="all">All Rarities</option>
                        <option value="normal">Normal</option>
                        <option value="rare">Rare</option>
                        <option value="epic">Epic</option>
                        <option value="mythical">Mythical</option>
                        <option value="legendary">Legendary</option>
                        <option value="relic">Relic</option>
                        <option value="ancient">Ancient</option>
                        <option value="exalted">Exalted</option>
                    </select>
                </div>
                <div class="inventory-grid" id="inventory-grid"></div>
                <p id="inventory-total" style="margin-top: 15px; text-align: center;"></p>
            </div>
        </div>

        <!-- Stats Page -->
        <div class="page" id="page-stats">
            <div class="card">
                <h2>üìä Statistics</h2>
                <div class="stats-grid" id="stats-grid"></div>
            </div>
        </div>

        <!-- Achievements Page -->
        <div class="page" id="page-achievements">
            <div class="card">
                <h2>üèÜ Achievements</h2>
                <p style="margin-bottom: 15px;" id="achievement-progress"></p>
                <div class="grid" id="achievement-grid"></div>
            </div>
        </div>
    </div>

    <!-- Export/Import Modal -->
    <div class="modal" id="save-modal">
        <div class="modal-content">
            <h2 id="modal-title">Export Save</h2>
            <textarea id="save-textarea" placeholder="Your save code will appear here..."></textarea>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="modal-close">Close</button>
                <button class="btn" id="modal-action">Copy</button>
            </div>
        </div>
    </div>

    <!-- Prestige Confirmation Modal -->
    <div class="modal" id="prestige-modal">
        <div class="modal-content">
            <h2>üåü Confirm Prestige</h2>
            <p style="margin-bottom: 20px;">Are you sure you want to prestige? You will lose all your progress but gain permanent bonuses!</p>
            <p id="prestige-bonus-preview" style="color: #4ade80; margin-bottom: 20px;"></p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="prestige-cancel">Cancel</button>
                <button class="btn btn-prestige" id="prestige-confirm">Prestige!</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA DEFINITIONS ====================
        const HOES = [
            { name: "Wooden Hoe", multiplier: 1.0, cost: 0, emoji: "ü™µ" },
            { name: "Stone Hoe", multiplier: 2.4, cost: 500, emoji: "ü™®" },
            { name: "Lapis Hoe", multiplier: 3.7, cost: 1000, emoji: "üíé" },
            { name: "Gold Hoe", multiplier: 4.9, cost: 1500, emoji: "ü•á" },
            { name: "Iron Hoe", multiplier: 4, cost: 2000, emoji: "‚öôÔ∏è" },
            { name: "Diamond Hoe", multiplier: 2.3, cost: 2500, emoji: "üí†" },
            { name: "Netherite Hoe", multiplier: 2.58, cost: 3000, emoji: "üî•" },
            { name: "Special Hoe", multiplier: 1.95, cost: 5000, emoji: "‚≠ê" },
            { name: "Emerald Hoe", multiplier: 3.2, cost: 7000, emoji: "üíö" },
            { name: "Obsidian Hoe", multiplier: 3.9, cost: 10000, emoji: "üñ§" },
            { name: "Mythic Hoe", multiplier: 3.6, cost: 15000, emoji: "üîÆ" },
            { name: "Platinum Hoe", multiplier: 5.2, cost: 20000, emoji: "ü™ô" },
            { name: "Titanium Hoe", multiplier: 6.99, cost: 450000, emoji: "‚ö°" },
            { name: "God Hoe", multiplier: 10.9, cost: 950000, emoji: "‚ú®" }
        ];

        const PLANTS = [
            { name: "Lettuce", price: 6, rarity: "normal", minHoe: 0, emoji: "ü•¨" },
            { name: "Potato", price: 7, rarity: "normal", minHoe: 0, emoji: "ü•î" },
            { name: "Spinach", price: 7, rarity: "normal", minHoe: 0, emoji: "ü•ó" },
            { name: "Tomato", price: 8, rarity: "normal", minHoe: 0, emoji: "üçÖ" },
            { name: "Cucumber", price: 9, rarity: "normal", minHoe: 0, emoji: "ü•í" },
            { name: "Carrot", price: 10, rarity: "normal", minHoe: 0, emoji: "ü•ï" },
            { name: "Crimson Carrot", price: 10.43, rarity: "normal", minHoe: 0, emoji: "ü•ï" },
            { name: "Golden Wheat", price: 13, rarity: "normal", minHoe: 1, emoji: "üåæ" },
            { name: "Bell Pepper", price: 17, rarity: "rare", minHoe: 1, emoji: "ü´ë" },
            { name: "Eggplant", price: 18, rarity: "rare", minHoe: 1, emoji: "üçÜ" },
            { name: "Broccoli", price: 14, rarity: "rare", minHoe: 2, emoji: "ü•¶" },
            { name: "Emerald Leaf", price: 15, rarity: "rare", minHoe: 2, emoji: "üçÄ" },
            { name: "Ruby Berry", price: 14.44, rarity: "rare", minHoe: 3, emoji: "üçí" },
            { name: "Strawberry", price: 15.3, rarity: "epic", minHoe: 4, emoji: "üçì" },
            { name: "Blueberry", price: 18.9, rarity: "epic", minHoe: 5, emoji: "ü´ê" },
            { name: "Silver Corn", price: 19, rarity: "epic", minHoe: 5, emoji: "üåΩ" },
            { name: "Avocado", price: 20, rarity: "epic", minHoe: 6, emoji: "ü•ë" },
            { name: "Mystic Herb", price: 25, rarity: "mythical", minHoe: 4, emoji: "üåø" },
            { name: "Saffron", price: 50, rarity: "legendary", minHoe: 6, emoji: "üå∏" },
            { name: "Truffle", price: 80, rarity: "legendary", minHoe: 6, emoji: "üçÑ" },
            { name: "Apple", price: 100, rarity: "relic", minHoe: 7, emoji: "üçé" },
            { name: "Green Apple", price: 150, rarity: "relic", minHoe: 7, emoji: "üçè" },
            { name: "Sacred Strawberry", price: 158, rarity: "relic", minHoe: 7, emoji: "üçì" },
            { name: "Brown Mushroom", price: 130, rarity: "relic", minHoe: 8, emoji: "üçÑ‚Äçüü´" },
            { name: "Eternal Herb", price: 135, rarity: "relic", minHoe: 8, emoji: "üåø" },
            { name: "Ancient Onion", price: 160, rarity: "ancient", minHoe: 8, emoji: "üßÖ" },
            { name: "Extraordinary Ginger", price: 165, rarity: "ancient", minHoe: 8, emoji: "ü´ö" },
            { name: "Bell Pepper", price: 170, rarity: "ancient", minHoe: 8, emoji: "üå∂Ô∏è" },
            { name: "Sugar Coconut", price: 195, rarity: "ancient", minHoe: 9, emoji: "ü••" },
            { name: "Citrus", price: 180, rarity: "ancient", minHoe: 9, emoji: "üçä" },
            { name: "Ancient Herb Bloom", price: 205, rarity: "ancient", minHoe: 9, emoji: "üåø" },
            { name: "Moon Melon", price: 185, rarity: "ancient", minHoe: 9, emoji: "üçâ" },
            { name: "The Beans", price: 400, rarity: "exalted", minHoe: 9, emoji: "ü´ò" },
            { name: "Pink Saffron", price: 630, rarity: "exalted", minHoe: 10, emoji: "üå∏" },
            { name: "Pink Truffle", price: 850, rarity: "exalted", minHoe: 10, emoji: "üçÑ" }
        ];

        const FERTILIZERS = [
            { name: "Mud", bonus: 1, cost: 50, emoji: "üü§" },
            { name: "Soil", bonus: 2, cost: 100, emoji: "üü´" },
            { name: "Compost", bonus: 3, cost: 200, emoji: "‚ôªÔ∏è" },
            { name: "Manure", bonus: 5, cost: 300, emoji: "üí©" },
            { name: "Organic", bonus: 8, cost: 500, emoji: "üå±" },
            { name: "Bio", bonus: 10, cost: 800, emoji: "üß¨" },
            { name: "Vermicompost", bonus: 12, cost: 1000, emoji: "ü™±" },
            { name: "Liquid", bonus: 15, cost: 1200, emoji: "üíß" },
            { name: "Chemical", bonus: 30, cost: 1500, emoji: "‚öóÔ∏è" },
            { name: "Superphosphate", bonus: 40, cost: 1800, emoji: "üî¨" }
        ];

        const UPGRADES = [
            { id: "sharperTools", name: "Sharper Tools", desc: "+1 yield per level", maxLevel: 20, baseCost: 250, emoji: "üî™" },
            { id: "expertFarmer", name: "Expert Farmer", desc: "+10% sell price per level", maxLevel: 10, baseCost: 250, emoji: "üë®‚Äçüåæ" },
            { id: "businessman", name: "Businessman", desc: "+5% sell price per level", maxLevel: 20, baseCost: 500, emoji: "üíº" },
            { id: "marketSpecialist", name: "Market Specialist", desc: "+5% sell price per level", maxLevel: 10, baseCost: 750, emoji: "üìà" },
            { id: "irrigationSystem", name: "Irrigation System", desc: "√ó1.2 yield per level", maxLevel: 5, baseCost: 1000, emoji: "üí¶" },
            { id: "automatedSprinkler", name: "Automated Sprinkler", desc: "+2 yield per level", maxLevel: 10, baseCost: 2000, emoji: "üöø" },
            { id: "duplicator", name: "Duplicator", desc: "+5% double yield chance per level", maxLevel: 3, baseCost: 2500, emoji: "‚ú®" },
            { id: "experienced", name: "Experienced", desc: "+20% XP per level", maxLevel: 5, baseCost: 2500, emoji: "üìö" },
            { id: "fertilizerEfficiency", name: "Fertilizer Efficiency", desc: "+10% fertilizer bonus per level", maxLevel: 5, baseCost: 1500, emoji: "üß™" },
            { id: "seedMultiplier", name: "Seed Multiplier", desc: "+5% yield per level", maxLevel: 20, baseCost: 4000, emoji: "üå∞" },
            { id: "advancedAnalytics", name: "Advanced Analytics", desc: "+3% to all bonuses per level", maxLevel: 40, baseCost: 3000, emoji: "üñ•Ô∏è" }
        ];

        const ACHIEVEMENTS = [
            { id: "firstSteps", name: "First Steps", desc: "Harvest your first plant", icon: "üå±", check: (g, s) => s.totalFarms >= 1 },
            { id: "businessman", name: "Businessman", desc: "Earn $10,000 in a single sale", icon: "üí∞", check: (g, s) => s.bestSale >= 10000 },
            { id: "collector", name: "Collector", desc: "Harvest all 20 plant types at least once", icon: "üéí", check: (g, s) => s.uniquePlantsHarvested >= 20 },
            { id: "legendaryHarvest", name: "Legendary Harvest", desc: "Obtain a Truffle or Saffron", icon: "üèÜ", check: (g, s) => s.legendaryHarvested > 0 },
            { id: "efficiencyExpert", name: "Efficiency Expert", desc: "Max out Fertilizer Efficiency", icon: "üß™", check: (g) => g.upgrades.fertilizerEfficiency >= 5 },
            { id: "toolMaster", name: "Tool Master", desc: "Unlock all 13 hoes", icon: "üõ†Ô∏è", check: (g) => g.unlockedHoes.length >= 13 },
            { id: "greenThumb", name: "Green Thumb", desc: "Harvest 10,000 total plants", icon: "üåø", check: (g, s) => s.totalPlantsHarvested >= 10000 },
            { id: "millionaire", name: "Millionaire", desc: "Accumulate $1,000,000 total balance", icon: "ü§ë", check: (g, s) => s.totalEarned >= 1000000 },
            { id: "prestigeI", name: "Prestige I", desc: "Complete your first prestige", icon: "‚≠ê", check: (g) => g.prestigeLevel >= 1 },
            { id: "prestigeV", name: "Prestige V", desc: "Reach prestige level 5", icon: "üåü", check: (g) => g.prestigeLevel >= 5 },
            { id: "fertilzerFanatic", name: "Fertilizer Fanatic", desc: "Use 1,000 fertilizer units", icon: "üß¨", check: (g, s) => s.totalFertilizerUsed >= 1000 },
            { id: "speedRunner", name: "Speed Runner", desc: "Perform 100 farms in one session", icon: "‚ö°", check: (g, s) => s.sessionFarms >= 100 },
            { id: "richFarmer", name: "Rich Farmer", desc: "Have $50,000 balance at once", icon: "üíé", check: (g) => g.balance >= 50000 },
            { id: "upgradeAddict", name: "Upgrade Addict", desc: "Purchase 50 total upgrade levels", icon: "‚¨ÜÔ∏è", check: (g) => Object.values(g.upgrades).reduce((a, b) => a + b, 0) >= 50 },
            { id: "completionist", name: "Completionist", desc: "Max all upgrades", icon: "üèÖ", check: (g) => UPGRADES.every(u => g.upgrades[u.id] >= u.maxLevel) }
        ];

        const RARITY_CONSUMPTION = { normal: 1, rare: 2, epic: 3, legendary: 4, mythical: 5, relic: 20, ancient: 80, exalted: 320 };
        const RARITY_ORDER = { normal: 0, rare: 1, epic: 2, mythical: 3, legendary: 4, relic: 5, ancient: 6, exalted: 7 };

        // ==================== GAME STATE ====================
        let game = null;
        let stats = null;
        let cooldownActive = false;
        let cooldownEndTime = 0;
        const COOLDOWN_DURATION = 1500;

        function getDefaultGame() {
            return {
                balance: 0,
                xp: 0,
                prestigeLevel: 0,
                prestigeBonus: 0,
                currentHoeIndex: 0,
                selectedHoeIndex: 0,
                unlockedHoes: [0],
                selectedFertilizer: "none",
                fertilizers: {},
                upgrades: {},
                inventory: {},
                achievements: []
            };
        }

        function getDefaultStats() {
            return {
                totalFarms: 0,
                totalPlantsHarvested: 0,
                totalEarned: 0,
                totalSpent: 0,
                totalFertilizerUsed: 0,
                bestYield: 0,
                bestSale: 0,
                uniquePlantsHarvested: 0,
                legendaryHarvested: 0,
                sessionFarms: 0,
                plantsHarvestedTypes: {}
            };
        }

        function initGame() {
            FERTILIZERS.forEach(f => {
                if (game.fertilizers[f.name] === undefined) game.fertilizers[f.name] = 0;
            });
            UPGRADES.forEach(u => {
                if (game.upgrades[u.id] === undefined) game.upgrades[u.id] = 0;
            });
            PLANTS.forEach(p => {
                if (game.inventory[p.name] === undefined) game.inventory[p.name] = 0;
                if (stats.plantsHarvestedTypes[p.name] === undefined) stats.plantsHarvestedTypes[p.name] = 0;
            });
        }

        // ==================== NUMBER FORMATTING ====================
        function formatNumber(num) {
            if (num < 1000) return Math.floor(num).toLocaleString();
            if (num < 1000000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
            if (num < 1e9) return (num / 1e6).toFixed(2).replace(/\.00$/, '').replace(/(\.\d)0$/, '$1') + ' million';
            if (num < 1e12) return (num / 1e9).toFixed(2).replace(/\.00$/, '').replace(/(\.\d)0$/, '$1') + ' billion';
            if (num < 1e15) return (num / 1e12).toFixed(2).replace(/\.00$/, '').replace(/(\.\d)0$/, '$1') + ' trillion';
            if (num < 1e18) return (num / 1e15).toFixed(2).replace(/\.00$/, '').replace(/(\.\d)0$/, '$1') + ' quadrillion';
            if (num < 1e21) return (num / 1e18).toFixed(2).replace(/\.00$/, '').replace(/(\.\d)0$/, '$1') + ' quintillion';
            if (num < 1e24) return (num / 1e21).toFixed(2).replace(/\.00$/, '').replace(/(\.\d)0$/, '$1') + ' sextillion';
            return (num / 1e24).toFixed(2).replace(/\.00$/, '').replace(/(\.\d)0$/, '$1') + ' septillion';
        }

        function formatMoney(num) {
            return '$' + formatNumber(num);
        }

        // ==================== SAVE/LOAD ====================
        function saveGame() {
            try {
                const saveData = { game, stats, version: 1, timestamp: Date.now() };
                localStorage.setItem('virtualFarmerSave', JSON.stringify(saveData));
            } catch (e) {
                console.error("Save failed:", e);
            }
        }

        function loadGame() {
            try {
                const savedData = localStorage.getItem('virtualFarmerSave');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    if (parsed.game && parsed.game.balance !== undefined) {
                        game = { ...getDefaultGame(), ...parsed.game };
                        stats = { ...getDefaultStats(), ...parsed.stats };
                    } else {
                        throw new Error("Invalid save structure");
                    }
                } else {
                    game = getDefaultGame();
                    stats = getDefaultStats();
                }
            } catch (e) {
                console.error("Load failed:", e);
                game = getDefaultGame();
                stats = getDefaultStats();
            }
            initGame();
        }

        function exportSave() {
            const saveData = { game, stats, version: 1, timestamp: Date.now() };
            return btoa(JSON.stringify(saveData));
        }

        function importSave(code) {
            try {
                const decoded = JSON.parse(atob(code));
                if (decoded.game && decoded.game.balance !== undefined) {
                    game = { ...getDefaultGame(), ...decoded.game };
                    stats = { ...getDefaultStats(), ...decoded.stats };
                    initGame();
                    saveGame();
                    updateAllUI();
                    showNotification("Save imported successfully!", "achievement");
                    return true;
                }
            } catch (e) {
                console.error("Import failed:", e);
            }
            showNotification("Invalid save code!", "normal");
            return false;
        }

        // ==================== NOTIFICATIONS ====================
        function showNotification(message, rarity = "normal") {
            const container = document.getElementById('notifications');
            const notif = document.createElement('div');
            notif.className = `notification ${rarity}`;
            notif.textContent = message;
            container.appendChild(notif);
            setTimeout(() => notif.remove(), 2500);
        }

        // ==================== CALCULATIONS ====================
        function getUpgradeCost(upgrade, level) {
            return Math.floor(upgrade.baseCost * Math.pow(5.15, level));
        }

        function calculateYield() {
            const hoe = HOES[game.selectedHoeIndex];
            let baseYield = 10 + game.selectedHoeIndex * 5 + Math.floor(Math.random() * 10);
            
            // Hoe multiplier
            baseYield *= hoe.multiplier;
            
            // Prestige bonus
            baseYield *= (1 + game.prestigeBonus / 100);
            
            // Sharper Tools
            baseYield += game.upgrades.sharperTools || 0;
            
            // Automated Sprinkler
            baseYield += (game.upgrades.automatedSprinkler || 0) * 2;
            
            // Irrigation System (multiplicative)
            baseYield *= Math.pow(1.2, game.upgrades.irrigationSystem || 0);
            
            // Seed Multiplier
            baseYield *= (1 + (game.upgrades.seedMultiplier || 0) * 0.05);
            
            // Advanced Analytics
            baseYield *= (1 + (game.upgrades.advancedAnalytics || 0) * 0.03);
            
            // Fertilizer
            if (game.selectedFertilizer !== "none" && game.fertilizers[game.selectedFertilizer] > 0) {
                const fert = FERTILIZERS.find(f => f.name === game.selectedFertilizer);
                if (fert) {
                    let fertBonus = fert.bonus;
                    fertBonus *= (1 + (game.upgrades.fertilizerEfficiency || 0) * 0.1);
                    baseYield += fertBonus;
                }
            }
            
            // Duplicator chance
            const dupChance = (game.upgrades.duplicator || 0) * 0.05;
            if (Math.random() < dupChance) {
                baseYield *= 2;
            }
            
            return Math.floor(baseYield);
        }

        function calculateXP() {
            let baseXP = 10 + game.selectedHoeIndex * 5 + Math.floor(Math.random() * 5);
            baseXP *= (1 + (game.upgrades.experienced || 0) * 0.2);
            baseXP *= (1 + game.prestigeBonus / 100);
            return Math.min(Math.floor(baseXP), 100);
        }

        function calculateSellPrice() {
            let totalValue = 0;
            for (const [plantName, quantity] of Object.entries(game.inventory)) {
                if (quantity > 0) {
                    const plant = PLANTS.find(p => p.name === plantName);
                    if (plant) {
                        totalValue += plant.price * quantity;
                    }
                }
            }
            
            // Apply price multipliers
            let multiplier = 1;
            multiplier *= (1 + (game.upgrades.expertFarmer || 0) * 0.1);
            multiplier *= (1 + (game.upgrades.businessman || 0) * 0.05);
            multiplier *= (1 + (game.upgrades.marketSpecialist || 0) * 0.05);
            multiplier *= (1 + (game.upgrades.advancedAnalytics || 0) * 0.03);
            multiplier *= (1 + game.prestigeBonus / 100);
            
            return Math.floor(totalValue * multiplier);
        }

        function getTotalPlants() {
            return Object.values(game.inventory).reduce((a, b) => a + b, 0);
        }

        function canPrestige() {
            return game.balance >= 5000000 || UPGRADES.every(u => game.upgrades[u.id] >= u.maxLevel);
        }

        // ==================== GAME ACTIONS ====================
        function farm() {
            if (cooldownActive) return;
            
            // Start cooldown
            cooldownActive = true;
            cooldownEndTime = Date.now() + COOLDOWN_DURATION;
            updateCooldownBar();
            
            // Get eligible plants
            const eligiblePlants = PLANTS.filter(p => p.minHoe <= game.selectedHoeIndex);
            const selectedPlant = eligiblePlants[Math.floor(Math.random() * eligiblePlants.length)];
            
            // Calculate yield
            const yieldAmount = calculateYield();
            const xpGained = calculateXP();
            
            // Consume fertilizer
            if (game.selectedFertilizer !== "none" && game.fertilizers[game.selectedFertilizer] > 0) {
                const consumption = RARITY_CONSUMPTION[selectedPlant.rarity] || 1;
                const available = game.fertilizers[game.selectedFertilizer];
                const consumed = Math.min(consumption, available);
                game.fertilizers[game.selectedFertilizer] -= consumed;
                stats.totalFertilizerUsed += consumed;
                
                if (game.fertilizers[game.selectedFertilizer] <= 0) {
                    game.selectedFertilizer = "none";
                }
            }
            
            // Add to inventory
            game.inventory[selectedPlant.name] = (game.inventory[selectedPlant.name] || 0) + yieldAmount;
            game.xp += xpGained;
            
            // Update stats
            stats.totalFarms++;
            stats.sessionFarms++;
            stats.totalPlantsHarvested += yieldAmount;
            if (yieldAmount > stats.bestYield) stats.bestYield = yieldAmount;
            if (stats.plantsHarvestedTypes[selectedPlant.name] === 0) {
                stats.uniquePlantsHarvested++;
            }
            stats.plantsHarvestedTypes[selectedPlant.name] += yieldAmount;
            if (selectedPlant.rarity === "legendary") {
                stats.legendaryHarvested += yieldAmount;
            }
            
            // Show notification
            showNotification(`${selectedPlant.emoji} Harvested ${yieldAmount} ${selectedPlant.name}!`, selectedPlant.rarity);
            
            checkAchievements();
            saveGame();
            updateAllUI();
        }

        function updateCooldownBar() {
            const bar = document.getElementById('cooldown-bar');
            const btn = document.getElementById('farm-btn');
            
            function update() {
                const now = Date.now();
                if (now >= cooldownEndTime) {
                    cooldownActive = false;
                    bar.style.width = '0%';
                    btn.disabled = false;
                    return;
                }
                
                const remaining = cooldownEndTime - now;
                const percent = (remaining / COOLDOWN_DURATION) * 100;
                bar.style.width = percent + '%';
                btn.disabled = true;
                requestAnimationFrame(update);
            }
            update();
        }

        function sellAll() {
            const totalPlants = getTotalPlants();
            if (totalPlants === 0) {
                showNotification("No plants to sell!", "normal");
                return;
            }
            
            const saleValue = calculateSellPrice();
            game.balance += saleValue;
            stats.totalEarned += saleValue;
            if (saleValue > stats.bestSale) stats.bestSale = saleValue;
            
            // Clear inventory
            for (const plant of PLANTS) {
                game.inventory[plant.name] = 0;
            }
            
            showNotification(`üí∞ Sold for ${formatMoney(saleValue)}!`, "achievement");
            
            checkAchievements();
            saveGame();
            updateAllUI();
        }

        function buyHoe(index) {
            const hoe = HOES[index];
            if (game.unlockedHoes.includes(index)) return;
            if (game.balance < hoe.cost) return;
            
            game.balance -= hoe.cost;
            stats.totalSpent += hoe.cost;
            game.unlockedHoes.push(index);
            game.currentHoeIndex = Math.max(game.currentHoeIndex, index);
            
            showNotification(`${hoe.emoji} Unlocked ${hoe.name}!`, "achievement");
            
            checkAchievements();
            saveGame();
            updateAllUI();
        }

        function equipHoe(index) {
            if (!game.unlockedHoes.includes(index)) return;
            game.selectedHoeIndex = index;
            saveGame();
            updateAllUI();
        }

        function buyFertilizer(name, amount = 1) {
            const fert = FERTILIZERS.find(f => f.name === name);
            if (!fert) return;
            
            const totalCost = fert.cost * amount;
            if (game.balance < totalCost) return;
            
            game.balance -= totalCost;
            stats.totalSpent += totalCost;
            game.fertilizers[name] = (game.fertilizers[name] || 0) + amount;
            
            showNotification(`${fert.emoji} Bought ${amount}x ${name}!`, "normal");
            
            saveGame();
            updateAllUI();
        }

        function buyUpgrade(id) {
            const upgrade = UPGRADES.find(u => u.id === id);
            if (!upgrade) return;
            
            const currentLevel = game.upgrades[id] || 0;
            if (currentLevel >= upgrade.maxLevel) return;
            
            const cost = getUpgradeCost(upgrade, currentLevel);
            if (game.balance < cost) return;
            
            game.balance -= cost;
            stats.totalSpent += cost;
            game.upgrades[id] = currentLevel + 1;
            
            showNotification(`${upgrade.emoji} ${upgrade.name} ‚Üí Lv.${currentLevel + 1}!`, "rare");
            
            checkAchievements();
            saveGame();
            updateAllUI();
        }

        function prestige() {
            if (!canPrestige()) return;
            
            game.prestigeLevel++;
            game.prestigeBonus = game.prestigeLevel * 2;
            
            // Reset progress
            game.balance = 900000000000000;
            game.xp = 0;
            game.currentHoeIndex = 0;
            game.selectedHoeIndex = 0;
            game.unlockedHoes = [0];
            game.selectedFertilizer = "none";
            
            for (const fert of FERTILIZERS) {
                game.fertilizers[fert.name] = 0;
            }
            for (const upgrade of UPGRADES) {
                game.upgrades[upgrade.id] = 0;
            }
            for (const plant of PLANTS) {
                game.inventory[plant.name] = 0;
            }
            
            showNotification(`üåü You've reached prestige ${game.prestigeLevel}! +${game.prestigeBonus}% bonus!`, "legendary");
            
            document.getElementById('prestige-modal').classList.remove('active');
            
            checkAchievements();
            saveGame();
            updateAllUI();
        }

        // ==================== ACHIEVEMENTS ====================
        function checkAchievements() {
            for (const achievement of ACHIEVEMENTS) {
                if (!game.achievements.includes(achievement.id)) {
                    if (achievement.check(game, stats)) {
                        game.achievements.push(achievement.id);
                        showNotification(`üèÜ Achievement: ${achievement.name}!`, "achievement");
                    }
                }
            }
        }

        // ==================== UI UPDATES ====================
        function updateAllUI() {
            updateStatsBar();
            updateHoeSelect();
            updateFertilizerSelect();
            updatePrestigeCard();
            updateShopPage();
            updateUpgradesPage();
            updateInventoryPage();
            updateStatsPage();
            updateAchievementsPage();
        }

        function updateStatsBar() {
            document.getElementById('balance-display').textContent = formatMoney(game.balance);
            document.getElementById('xp-display').textContent = formatNumber(game.xp);
            document.getElementById('plants-display').textContent = formatNumber(getTotalPlants());
            document.getElementById('hoe-display').textContent = HOES[game.selectedHoeIndex].name;
            document.getElementById('prestige-display').textContent = `‚≠ê ${game.prestigeLevel} (+${game.prestigeBonus}%)`;
        }

        function updateHoeSelect() {
            const select = document.getElementById('hoe-select');
            select.innerHTML = '';
            
            for (const index of game.unlockedHoes.sort((a, b) => a - b)) {
                const hoe = HOES[index];
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${hoe.emoji} ${hoe.name} (${hoe.multiplier}x)`;
                option.selected = index === game.selectedHoeIndex;
                select.appendChild(option);
            }
        }

        function updateFertilizerSelect() {
            const select = document.getElementById('fertilizer-select');
            select.innerHTML = '<option value="none">No Fertilizer</option>';
            
            for (const fert of FERTILIZERS) {
                const qty = game.fertilizers[fert.name] || 0;
                if (qty > 0) {
                    const option = document.createElement('option');
                    option.value = fert.name;
                    option.textContent = `${fert.emoji} ${fert.name} (+${fert.bonus}) [${qty}]`;
                    option.selected = fert.name === game.selectedFertilizer;
                    select.appendChild(option);
                }
            }
        }

        function updatePrestigeCard() {
            const card = document.getElementById('prestige-card');
            const desc = document.getElementById('prestige-description');
            
            if (canPrestige()) {
                card.style.display = 'block';
                const newBonus = (game.prestigeLevel + 1) * 2;
                desc.textContent = `Reset your progress to gain Prestige Level ${game.prestigeLevel + 1} with a permanent +${newBonus}% bonus to all yields and earnings!`;
            } else {
                card.style.display = 'none';
            }
        }

        function updateShopPage() {
            // Hoes
            const hoeGrid = document.getElementById('hoe-grid');
            hoeGrid.innerHTML = '';
            
            for (let i = 0; i < HOES.length; i++) {
                const hoe = HOES[i];
                const owned = game.unlockedHoes.includes(i);
                const equipped = game.selectedHoeIndex === i;
                const canBuy = !owned && game.balance >= hoe.cost;
                
                const card = document.createElement('div');
                card.className = `item-card${owned ? ' owned' : ''}${equipped ? ' equipped' : ''}`;
                card.innerHTML = `
                    <div class="item-header">
                        <span class="item-name">${hoe.emoji} ${hoe.name}</span>
                        <span class="item-price">${hoe.cost === 0 ? 'Free' : formatMoney(hoe.cost)}</span>
                    </div>
                    <div class="item-stats">Multiplier: ${hoe.multiplier}x</div>
                    ${owned 
                        ? (equipped 
                            ? '<button class="btn" disabled>Equipped</button>'
                            : `<button class="btn btn-secondary" onclick="equipHoe(${i})">Equip</button>`)
                        : `<button class="btn" ${canBuy ? '' : 'disabled'} onclick="buyHoe(${i})">Buy</button>`
                    }
                `;
                hoeGrid.appendChild(card);
            }
            
            // Fertilizers
            const fertGrid = document.getElementById('fertilizer-grid');
            fertGrid.innerHTML = '';
            
            for (const fert of FERTILIZERS) {
                const qty = game.fertilizers[fert.name] || 0;
                const canBuy = game.balance >= fert.cost;
                
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div class="item-header">
                        <span class="item-name">${fert.emoji} ${fert.name}</span>
                        <span class="item-price">${formatMoney(fert.cost)}</span>
                    </div>
                    <div class="item-stats">Bonus: +${fert.bonus} yield | Owned: ${qty}</div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn" ${canBuy ? '' : 'disabled'} onclick="buyFertilizer('${fert.name}', 1)">+1</button>
                        <button class="btn" ${game.balance >= fert.cost * 10 ? '' : 'disabled'} onclick="buyFertilizer('${fert.name}', 10)">+10</button>
                        <button class="btn btn-secondary" ${game.balance >= fert.cost * 100 ? '' : 'disabled'} onclick="buyFertilizer('${fert.name}', 100)">+100</button>
                    </div>
                `;
                fertGrid.appendChild(card);
            }
        }

        function updateUpgradesPage() {
            const grid = document.getElementById('upgrade-grid');
            grid.innerHTML = '';
            
            for (const upgrade of UPGRADES) {
                const level = game.upgrades[upgrade.id] || 0;
                const maxed = level >= upgrade.maxLevel;
                const cost = maxed ? 0 : getUpgradeCost(upgrade, level);
                const canBuy = !maxed && game.balance >= cost;
                
                const card = document.createElement('div');
                card.className = `item-card${maxed ? ' owned' : ''}`;
                card.innerHTML = `
                    <div class="item-header">
                        <span class="item-name">${upgrade.emoji} ${upgrade.name}</span>
                        <span class="upgrade-level">Lv. ${level}/${upgrade.maxLevel}</span>
                    </div>
                    <div class="item-stats">${upgrade.desc}</div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${(level / upgrade.maxLevel) * 100}%"></div>
                    </div>
                    ${maxed 
                        ? '<button class="btn" disabled>Maxed</button>'
                        : `<button class="btn" ${canBuy ? '' : 'disabled'} onclick="buyUpgrade('${upgrade.id}')">${formatMoney(cost)}</button>`
                    }
                `;
                grid.appendChild(card);
            }
        }

        function updateInventoryPage() {
            const grid = document.getElementById('inventory-grid');
            const sortBy = document.getElementById('sort-select').value;
            const filterBy = document.getElementById('filter-select').value;
            
            let items = PLANTS.map(p => ({
                ...p,
                quantity: game.inventory[p.name] || 0
            })).filter(p => p.quantity > 0);
            
            // Filter
            if (filterBy !== 'all') {
                items = items.filter(p => p.rarity === filterBy);
            }
            
            // Sort
            switch (sortBy) {
                case 'quantity':
                    items.sort((a, b) => b.quantity - a.quantity);
                    break;
                case 'value':
                    items.sort((a, b) => b.price - a.price);
                    break;
                case 'rarity':
                    items.sort((a, b) => RARITY_ORDER[b.rarity] - RARITY_ORDER[a.rarity]);
                    break;
                default:
                    items.sort((a, b) => a.name.localeCompare(b.name));
            }
            
            grid.innerHTML = '';
            
            if (items.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; opacity: 0.6;">No plants in inventory</p>';
            } else {
                for (const item of items) {
                    const div = document.createElement('div');
                    div.className = `inventory-item ${item.rarity}`;
                    div.innerHTML = `
                        <span>${item.emoji} ${item.name}</span>
                        <span>${formatNumber(item.quantity)}</span>
                    `;
                    grid.appendChild(div);
                }
            }
            
            const totalValue = calculateSellPrice();
            document.getElementById('inventory-total').textContent = 
                `Total Value: ${formatMoney(totalValue)} (${formatNumber(getTotalPlants())} plants)`;
        }

        function updateStatsPage() {
            const grid = document.getElementById('stats-grid');
            
            const statItems = [
                { label: "Total Farms", value: formatNumber(stats.totalFarms) },
                { label: "Total Plants Harvested", value: formatNumber(stats.totalPlantsHarvested) },
                { label: "Total Money Earned", value: formatMoney(stats.totalEarned) },
                { label: "Total Money Spent", value: formatMoney(stats.totalSpent) },
                { label: "Best Single Yield", value: formatNumber(stats.bestYield) },
                { label: "Best Single Sale", value: formatMoney(stats.bestSale) },
                { label: "Unique Plants Discovered", value: `${stats.uniquePlantsHarvested}/20` },
                { label: "Legendary Plants Harvested", value: formatNumber(stats.legendaryHarvested) },
                { label: "Fertilizer Used", value: formatNumber(stats.totalFertilizerUsed) },
                { label: "Session Farms", value: formatNumber(stats.sessionFarms) },
                { label: "Current Prestige Level", value: `‚≠ê ${game.prestigeLevel}` },
                { label: "Prestige Bonus", value: `+${game.prestigeBonus}%` }
            ];
            
            grid.innerHTML = statItems.map(s => `
                <div class="stats-card">
                    <div class="value">${s.value}</div>
                    <div class="label">${s.label}</div>
                </div>
            `).join('');
        }

        function updateAchievementsPage() {
            const grid = document.getElementById('achievement-grid');
            const unlocked = game.achievements.length;
            
            document.getElementById('achievement-progress').textContent = 
                `Unlocked: ${unlocked}/${ACHIEVEMENTS.length}`;
            
            grid.innerHTML = ACHIEVEMENTS.map(a => {
                const isUnlocked = game.achievements.includes(a.id);
                return `
                    <div class="achievement-card${isUnlocked ? ' unlocked' : ''}">
                        <div class="achievement-icon">${a.icon}</div>
                        <div class="achievement-info">
                            <h3>${a.name}</h3>
                            <p>${a.desc}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    
                    btn.classList.add('active');
                    document.getElementById(`page-${btn.dataset.page}`).classList.add('active');
                });
            });
            
            // Farm button
            document.getElementById('farm-btn').addEventListener('click', farm);
            
            // Sell button
            document.getElementById('sell-btn').addEventListener('click', sellAll);
            
            // Hoe select
            document.getElementById('hoe-select').addEventListener('change', (e) => {
                equipHoe(parseInt(e.target.value));
            });
            
            // Fertilizer select
            document.getElementById('fertilizer-select').addEventListener('change', (e) => {
                game.selectedFertilizer = e.target.value;
                saveGame();
            });
            
            // Inventory sort/filter
            document.getElementById('sort-select').addEventListener('change', updateInventoryPage);
            document.getElementById('filter-select').addEventListener('change', updateInventoryPage);
            
            // Export/Import
            document.getElementById('export-btn').addEventListener('click', () => {
                const modal = document.getElementById('save-modal');
                const textarea = document.getElementById('save-textarea');
                const actionBtn = document.getElementById('modal-action');
                
                document.getElementById('modal-title').textContent = 'Export Save';
                textarea.value = exportSave();
                textarea.readOnly = true;
                actionBtn.textContent = 'Copy';
                actionBtn.onclick = () => {
                    textarea.select();
                    document.execCommand('copy');
                    showNotification('Copied to clipboard!', 'achievement');
                };
                modal.classList.add('active');
            });
            
            document.getElementById('import-btn').addEventListener('click', () => {
                const modal = document.getElementById('save-modal');
                const textarea = document.getElementById('save-textarea');
                const actionBtn = document.getElementById('modal-action');
                
                document.getElementById('modal-title').textContent = 'Import Save';
                textarea.value = '';
                textarea.readOnly = false;
                textarea.placeholder = 'Paste your save code here...';
                actionBtn.textContent = 'Import';
                actionBtn.onclick = () => {
                    if (importSave(textarea.value.trim())) {
                        modal.classList.remove('active');
                    }
                };
                modal.classList.add('active');
            });
            
            document.getElementById('modal-close').addEventListener('click', () => {
                document.getElementById('save-modal').classList.remove('active');
            });
            
            // Prestige
            document.getElementById('prestige-btn').addEventListener('click', () => {
                const newBonus = (game.prestigeLevel + 1) * 2;
                document.getElementById('prestige-bonus-preview').textContent = 
                    `You will gain: Prestige Level ${game.prestigeLevel + 1} with +${newBonus}% permanent bonus!`;
                document.getElementById('prestige-modal').classList.add('active');
            });
            
            document.getElementById('prestige-cancel').addEventListener('click', () => {
                document.getElementById('prestige-modal').classList.remove('active');
            });
            
            document.getElementById('prestige-confirm').addEventListener('click', prestige);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                switch (e.code) {
                    case 'Space':
                        e.preventDefault();
                        farm();
                        break;
                    case 'KeyS':
                        sellAll();
                        break;
                    case 'KeyF':
                        const fertSelect = document.getElementById('fertilizer-select');
                        const options = fertSelect.options;
                        const currentIndex = fertSelect.selectedIndex;
                        const nextIndex = (currentIndex + 1) % options.length;
                        fertSelect.selectedIndex = nextIndex;
                        game.selectedFertilizer = fertSelect.value;
                        saveGame();
                        break;
                    case 'Digit1':
                    case 'Digit2':
                    case 'Digit3':
                    case 'Digit4':
                    case 'Digit5':
                    case 'Digit6':
                    case 'Digit7':
                    case 'Digit8':
                    case 'Digit9':
                        const hoeIndex = parseInt(e.code.slice(-1)) - 1;
                        if (game.unlockedHoes.includes(hoeIndex)) {
                            equipHoe(hoeIndex);
                        }
                        break;
                }
            });
        }

        // ==================== INITIALIZATION ====================
        function init() {
            loadGame();
            setupEventListeners();
            updateAllUI();
            
            // Auto-save every 30 seconds
            setInterval(saveGame, 30000);
        }

        init();
    </script>
</body>
</html>